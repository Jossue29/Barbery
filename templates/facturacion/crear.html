{% extends 'base.html' %}
{% block title %}Nueva Factura{% endblock %}

{% block content %}
<form method="post">
{% csrf_token %}

<div class="row">

  <!-- CLIENTE -->
  <div class="col-md-4">
    <div class="card mb-4">
      <div class="card-header fw-bold">Cliente</div>

      <div class="card-body">

        <div class="mb-3">
          <label>Teléfono</label>
          <input type="text"
                 id="telefono"
                 name="telefono"
                 class="form-control"
                 onchange="buscarCliente()"
                 required>
        </div>

        <div class="mb-3">
          <label>Nombre completo</label>
          <input type="text"
                 id="nombre"
                 name="nombre"
                 class="form-control"
                 required>
        </div>

        <input type="hidden" name="cliente_id" id="cliente_id">

        <button type="button"
                class="btn btn-success w-100"
                onclick="guardarCliente()">
          Usar / Guardar cliente
        </button>

      </div>
    </div>
  </div>


  <!-- DETALLE -->
  <div class="col-md-8">
    <div class="card mb-4">
      <div class="card-header fw-bold">Detalle de cortes</div>

      <div class="card-body">

        <div class="row mb-3">
          <div class="col-md-5">
            <select id="corte" class="form-select">
              <option value="">Seleccione corte</option>
              {% for c in cortes %}
              <option value="{{ c.id }}" data-precio="{{ c.precio }}">
                {{ c.nombre_corte }} - C$ {{ c.precio }}
              </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <input type="number" id="cantidad" class="form-control" value="1" min="1">
          </div>

          <div class="col-md-3">
            <button type="button"
                    class="btn btn-primary w-100"
                    onclick="agregar()">
              Agregar
            </button>
          </div>
        </div>

        <table class="table table-bordered align-middle">
          <thead>
            <tr>
              <th>Corte</th>
              <th>Precio</th>
              <th>Cant.</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="detalle"></tbody>
        </table>

        <h4 class="text-end">
          Total: C$ <span id="total">0.00</span>
        </h4>

        <input type="hidden" name="total_factura" id="total_factura">

      </div>
    </div>

    <button class="btn btn-success w-100">
      Guardar Factura
    </button>

  </div>

</div>
</form>

<script>
function recalcularTotal() {
  let total = 0;

  document.querySelectorAll('#detalle tr').forEach(row => {
    total += parseFloat(row.dataset.subtotal);
  });

  document.getElementById('total').innerText = total.toFixed(2);
  document.getElementById('total_factura').value = total.toFixed(2);
}

document.addEventListener('DOMContentLoaded', function() {

  function buscarCliente() {
    const telefono = document.querySelector('#telefono').value.trim();
    if (telefono.length !== 8) return; // solo buscar si tiene 8 dígitos

    fetch(`/clientes/ajax/buscar/?telefono=${telefono}`)
        .then(res => res.json())
        .then(data => {
            if (data.length > 0) {
                // auto-rellenar nombre y hidden cliente_id
                document.querySelector('#nombre').value = data[0].nombre;
                document.querySelector('#cliente_id').value = data[0].id;
            } else {
                // limpiar campos si no existe
                document.querySelector('#nombre').value = '';
                document.querySelector('#cliente_id').value = '';
            }
        });
}

function buscarCliente() {
    const telefono = document.querySelector('#telefono').value.trim();
    if (telefono.length !== 8) return; // solo buscar si tiene 8 dígitos

    fetch(`/clientes/ajax/buscar/?telefono=${telefono}`)
        .then(res => res.json())
        .then(data => {
            if (data.length > 0) {
                // auto-rellenar nombre y hidden cliente_id
                document.querySelector('#nombre').value = data[0].nombre;
                document.querySelector('#cliente_id').value = data[0].id;
            } else {
                // limpiar campos si no existe
                document.querySelector('#nombre').value = '';
                document.querySelector('#cliente_id').value = '';
            }
        });
}

function guardarCliente() {
    const nombre = document.querySelector('#nombre').value.trim();
    const telefono = document.querySelector('#telefono').value.trim();
    let clienteId = document.querySelector('#cliente_id').value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!nombre || !telefono) {
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'warning',
            title: 'Debes llenar ambos campos',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });
        return;
    }

    fetch('/clientes/ajax/crear/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `nombre=${encodeURIComponent(nombre)}&telefono=${encodeURIComponent(telefono)}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.error) {
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'error',
                title: data.error,
                showConfirmButton: false,
                timer: 2500,
                timerProgressBar: true
            });
        } else {
            // siempre actualizar hidden cliente_id y campos visibles
            clienteId = data.id;
            document.querySelector('#cliente_id').value = data.id;
            document.querySelector('#nombre').value = data.nombre;
            document.querySelector('#telefono').value = data.telefono;

            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Cliente guardado y seleccionado',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });
        }
    })
    .catch(err => {
        console.error(err);
        Swal.fire({
            toast: true,
            position: 'top-end',
            icon: 'error',
            title: 'Error al guardar el cliente',
            showConfirmButton: false,
            timer: 2500,
            timerProgressBar: true
        });
    });
}

// asignar evento al botón
document.addEventListener('DOMContentLoaded', function() {
    const boton = document.querySelector('button[onclick="guardarCliente()"]');
    if(boton) boton.addEventListener('click', guardarCliente);
});


  // asignar la función al botón
  const boton = document.querySelector('button[onclick="guardarCliente()"]');
  if(boton) boton.addEventListener('click', guardarCliente);

});

function agregar() {
  const select = document.getElementById('corte');
  const option = select.options[select.selectedIndex];
  if (!option.value) return;

  const precio = parseFloat(option.dataset.precio);
  const cantidad = parseInt(document.getElementById('cantidad').value);
  const subtotal = precio * cantidad;

  const fila = document.createElement('tr');
  fila.dataset.subtotal = subtotal;

  fila.innerHTML = `
    <td>${option.text}</td>
    <td>${precio.toFixed(2)}</td>
    <td>${cantidad}</td>
    <td>${subtotal.toFixed(2)}</td>
    <td>
      <button type="button"
              class="btn btn-sm btn-danger"
              onclick="this.closest('tr').remove(); recalcularTotal();">
        X
      </button>
    </td>

    <input type="hidden" name="corte_id[]" value="${option.value}">
    <input type="hidden" name="precio[]" value="${precio}">
    <input type="hidden" name="cantidad[]" value="${cantidad}">
    <input type="hidden" name="subtotal[]" value="${subtotal}">
  `;

  document.getElementById('detalle').appendChild(fila);
  recalcularTotal();
}

function buscarCliente() {
  const telefono = document.getElementById('telefono').value;

  fetch(`/clientes/ajax/buscar/?telefono=${telefono}`)
    .then(res => res.json())
    .then(data => {
      if (data.encontrado) {
        document.getElementById('nombre').value = data.nombre;
        document.getElementById('cliente_id').value = data.id;
      } else {
        document.getElementById('nombre').value = '';
        document.getElementById('cliente_id').value = '';
      }
    });
}

const inputTelefono = document.querySelector('#telefono');
const inputNombre = document.querySelector('#nombre');

inputTelefono.addEventListener('input', function() {
    const telefono = this.value.replace(/\s/g, '');

    if (telefono.length === 8) {  // solo cuando hay 8 dígitos
        fetch(`/clientes/ajax/buscar/?telefono=${telefono}`)
            .then(res => res.json())
            .then(data => {
                if (data.exists) {
                    inputNombre.value = data.nombre;
                } else {
                    inputNombre.value = '';
                }
            });
    } else {
        inputNombre.value = '';
    }
});


</script>

{% endblock %}
