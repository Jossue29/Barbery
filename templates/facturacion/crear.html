{% extends 'base.html' %}
{% block title %}Nueva Factura{% endblock %}

{% block content %}
<form method="post">
{% csrf_token %}

<div class="row">

  <!-- COLUMNA IZQUIERDA -->
  <div class="col-md-4">

    <!-- CLIENTE -->
    <div class="card mb-4">
      <div class="card-header fw-bold">Cliente</div>
      <div class="card-body">

        <div class="mb-3">
          <label>TelÃ©fono</label>
          <input type="text"
                 id="telefono"
                 name="telefono"
                 class="form-control"
                 required>
        </div>

        <div class="mb-3">
          <label>Nombre completo</label>
          <input type="text"
                 id="nombre"
                 name="nombre"
                 class="form-control"
                 required>
        </div>

        <input type="hidden" name="cliente_id" id="cliente_id">

        <button type="button"
                class="btn btn-success w-100"
                onclick="guardarCliente()">
          Usar / Guardar cliente
        </button>

      </div>
    </div>

    <!-- BARBERO / ESTILISTA -->
    <div class="card mb-4">
      <div class="card-header fw-bold">Barbero / Estilista</div>
      <div class="card-body">

        <div class="mb-3">
          <label>Seleccionar</label>
          <select name="barbero_id" class="form-select" required>
            <option value="">-- Seleccione --</option>
            {% for b in barberos %}
              <option value="{{ b.id }}">
                {{ b.nombre }} {{ b.apellido }}
              </option>
            {% endfor %}
          </select>
        </div>

      </div>
    </div>

  </div>

  <!-- COLUMNA DERECHA -->
  <div class="col-md-8">

    <div class="card mb-4">
      <div class="card-header fw-bold">Detalle de cortes</div>
      <div class="card-body">

        <div class="row mb-3">
          <div class="col-md-5">
            <select id="corte" class="form-select">
              <option value="">Seleccione corte</option>
              {% for c in cortes %}
                <option value="{{ c.id }}" data-precio="{{ c.precio }}">
                  {{ c.nombre_corte }} - C$ {{ c.precio }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-2">
            <input type="number" id="cantidad"
                   class="form-control" value="1" min="1">
          </div>

          <div class="col-md-3">
            <button type="button"
                    class="btn btn-primary w-100"
                    onclick="agregar()">
              Agregar
            </button>
          </div>
        </div>

        <table class="table table-bordered align-middle">
          <thead>
            <tr>
              <th>Corte</th>
              <th>Precio</th>
              <th>Cant.</th>
              <th>Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="detalle"></tbody>
        </table>

        <h4 class="text-end">
          Total: C$ <span id="total">0.00</span>
        </h4>

        <input type="hidden"
               name="total_factura"
               id="total_factura">

      </div>
    </div>

    <button type="button"
            class="btn btn-success w-100"
            data-coreui-toggle="modal"
            data-coreui-target="#confirmGuardarModal">
      Guardar Factura
    </button>

  </div>

</div>

</form>

<div class="modal fade" id="confirmGuardarModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar</h5>
        <button type="button" class="btn-close" data-coreui-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Â¿EstÃ¡ seguro de guardar esta factura e imprimir el recibo?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-coreui-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="confirmGuardarBtn">SÃ­, guardar e imprimir</button>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="toastMsg"
       class="toast align-items-center text-bg-success border-0"
       role="alert"
       aria-live="assertive"
       aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">
        âœ” AcciÃ³n realizada correctamente
      </div>
      <button type="button"
              class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>


 <script>

document.getElementById('confirmGuardarBtn').addEventListener('click', function() {
  const form = document.querySelector('form');
  const data = new FormData(form);
  
  fetch(form.action, {
    method: 'POST',
    body: data,
    headers: {
      'X-Requested-With': 'XMLHttpRequest'
    }
  })
  .then(res => res.json())
  .then(json => {
    if (json.ok) {
      // Cerramos el modal
      const modalEl = document.getElementById('confirmGuardarModal');
      const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
      modal.hide();


      // Abrimos el recibo en nueva pestaÃ±a
      window.open(`/facturacion/ticket/${json.factura_id}/`, '_blank');

      // Limpiamos el form
      window.location.reload();
    } else {
      showToast('Error al guardar la factura', 'danger');
    }
  });
});

function showToast(message, type = 'success') {
  const toastEl = document.getElementById('toastMsg');
  const toastBody = document.getElementById('toastBody');

  toastEl.className = `toast align-items-center text-bg-${type} border-0`;
  toastBody.innerText = message;

  const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
  toast.show();
}

function recalcularTotal() {
  let total = 0;
  document.querySelectorAll('#detalle tr').forEach(row => {
    total += parseFloat(row.dataset.subtotal);
  });
  document.getElementById('total').innerText = total.toFixed(2);
  document.getElementById('total_factura').value = total.toFixed(2);
}

function agregar() {
  const select = document.getElementById('corte');
  const option = select.options[select.selectedIndex];
  if (!option.value) return;

  const precio = parseFloat(option.dataset.precio);
  const cantidad = parseInt(document.getElementById('cantidad').value);
  const subtotal = precio * cantidad;

  const fila = document.createElement('tr');
  fila.dataset.subtotal = subtotal;

  fila.innerHTML = `
    <td>${option.text}</td>
    <td>${precio.toFixed(2)}</td>
    <td>${cantidad}</td>
    <td>${subtotal.toFixed(2)}</td>
    <td>
      <button type="button"
              class="btn btn-sm btn-danger"
              onclick="this.closest('tr').remove(); recalcularTotal();">
        X
      </button>
    </td>

    <input type="hidden" name="corte_id[]" value="${option.value}">
    <input type="hidden" name="precio[]" value="${precio}">
    <input type="hidden" name="cantidad[]" value="${cantidad}">
    <input type="hidden" name="subtotal[]" value="${subtotal}">
  `;

  document.getElementById('detalle').appendChild(fila);
  recalcularTotal();
}

function guardarCliente() {
  const nombre = nombreInput.value.trim();
  const telefono = telefonoInput.value.trim();
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

  if (!nombre || !telefono) return;

  fetch('/clientes/ajax/crear/', {
    method: 'POST',
    headers: {
      'X-CSRFToken': csrf,
      'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: `nombre=${nombre}&telefono=${telefono}`
  })
  .then(r => r.json())
  .then(data => {
    document.getElementById('cliente_id').value = data.id;
    showToast('Cliente guardado correctamente ðŸ§¾');
  });
}

const telefonoInput = document.getElementById('telefono');
const nombreInput = document.getElementById('nombre');

telefonoInput.addEventListener('input', () => {
  const tel = telefonoInput.value;
  if (tel.length !== 8) return;

  fetch(`/clientes/ajax/buscar/?telefono=${tel}`)
    .then(r => r.json())
    .then(data => {
      if (data.exists) {
        nombreInput.value = data.nombre;
        document.getElementById('cliente_id').value = data.id;
        showToast('Cliente encontrado âœ…', 'info');
      } else {
        nombreInput.value = '';
        document.getElementById('cliente_id').value = '';
        showToast('Cliente nuevo ðŸ†•', 'warning');
      }
    });
});

function confirmarGuardarFactura() {
  if (!confirm('Â¿EstÃ¡ seguro de guardar esta factura?')) return;

  const form = document.querySelector('form');

  // Cambiamos temporalmente la acciÃ³n del form para redirigir al recibo
  form.addEventListener('submit', function(e) {
    e.preventDefault(); // prevenimos submit normal
    const data = new FormData(form);

    fetch(form.action, {
      method: 'POST',
      body: data,
    })
    .then(response => response.json()) // ojo, debemos cambiar la vista para que devuelva JSON
    .then(json => {
      if (json.ok) {
        // Abrimos la vista del recibo en nueva ventana
        window.open(`/facturacion/ticket/${json.factura_id}/`, '_blank');
        // recargamos la pÃ¡gina de crear factura
        window.location.reload();
      } else {
        showToast('Error al guardar la factura', 'danger');
      }
    });
  }, { once: true });

  form.submit(); // disparar el submit
}

</script>
{% endblock %}