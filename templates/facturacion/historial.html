{% extends 'base.html' %}
{% block title %}Historial de Facturas{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Historial de Facturas</h2>

    <!-- Filtros por fecha -->
    <div class="mb-3">
        <a href="?filtro=hoy{% if barbero_id %}&barbero={{ barbero_id }}{% endif %}"
           class="btn btn-outline-primary {% if filtro == 'hoy' %}active{% endif %}">
            Hoy
        </a>

        <a href="?filtro=semana{% if barbero_id %}&barbero={{ barbero_id }}{% endif %}"
           class="btn btn-outline-primary {% if filtro == 'semana' %}active{% endif %}">
            Esta Semana
        </a>
    </div>

    <!-- Filtro por barbero -->
    <form method="get" class="mb-3">
        <input type="hidden" name="filtro" value="{{ filtro }}">
        <select name="barbero" class="form-select" onchange="this.form.submit()">
            <option value="">-- Todos los barberos --</option>
            {% for b in barberos %}
                <option value="{{ b.id }}"
                    {% if barbero_id|default:'' == b.id|stringformat:"s" %}selected{% endif %}>
                    {{ b.get_full_name|default:b.username }}
                </option>
            {% endfor %}
        </select>
    </form>

    <!-- Tabla -->
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Factura</th>
                <th>Cliente</th>
                <th>Barbero / Estilista</th>
                <th>Fecha</th>
                <th>Total C$</th>
                <th>Comisión Negocio C$</th>
            </tr>
        </thead>
        <tbody>
            {% for f in facturas %}
            <tr>
                <td>{{ f.codigo }}</td>
                <td>{{ f.cliente }}</td>
                <td>{{ f.barbero }}</td>
                <td>{{ f.fecha|date:"d/m/Y H:i" }}</td>
                <td>{{ f.total|floatformat:2 }}</td>
                <td>{{ f.comision_negocio|floatformat:2 }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="6" class="text-center">No hay facturas</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pago al barbero -->
    {% if barbero_id %}
        <div class="mt-3">
            <h4>Total pendiente a pagar: C$ {{ total_pendiente|floatformat:2 }}</h4>

            <button class="btn btn-success"
                {% if not es_dia_pago or total_pendiente == 0 %}disabled{% endif %}
                onclick="pagarBarbero()">
                Pagar barbero
            </button>

            {% if not es_dia_pago %}
                <p class="text-muted mt-1">
                    * El pago solo se habilita el día autorizado.
                </p>
            {% endif %}
        </div>
    {% endif %}

    <hr>

    <!-- Totales generales -->
    <h4>Total facturado: C$ {{ total_facturado|floatformat:2 }}</h4>
    <h4>Comisión negocio: C$ {{ total_comision_negocio|floatformat:2 }}</h4>
</div>

<script>
function pagarBarbero() {
    if (!confirm('¿Confirmar pago al barbero?')) return;

    fetch("{% url 'pagar_cobros_barbero' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
            barbero_id: "{{ barbero_id }}"
        })
    })
    .then(res => res.json())
    .then(data => {
        alert(data.msg);
        if (data.ok) {
            location.reload();
        }
    });
}
</script>
{% endblock %}
